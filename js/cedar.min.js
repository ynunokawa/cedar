!function(a){"use strict";"function"==typeof define&&define.amd?define(["vega","d3"],function(b,c){return a(b,c)}):"object"==typeof module&&"object"==typeof module.exports&&(module.exports=a(require("vega"),require("d3"))),"undefined"!=typeof window&&window.vg&&window.d3&&(window.Cedar=a(window.vg,window.d3))}(function(a,b){"use strict";var c=function d(a){var b=this,c=a||{};if(this._events=[],this._definition=d._defaultDefinition(),this._view=void 0,this._methodQueue=[],this._pendingXhr=!1,c.definition)if("object"==typeof c.definition)this._definition=c.definition;else{if("string"!=typeof c.definition)throw new Error("parameter definition must be an object or string (url)");this._pendingXhr=!0,d.getJson(c.definition,function(a,c){b._pendingXhr=!1,b._definition=c,b._purgeMethodQueue()})}if(c.override&&(this._definition.override=c.override),c.specification)if("object"==typeof c.specification)this._definition.specification=c.specification;else{if("string"!=typeof c.specification)throw new Error("parameter template must be an object or string (url)");this._pendingXhr=!0,d.getJson(c.specification,function(a,c){b._pendingXhr=!1,b._definition.specification=c,b._purgeMethodQueue()})}c.dataset&&"object"==typeof c.dataset&&(c.dataset.query=d._mixin({},d._defaultQuery(),c.dataset.query),this._definition.dataset=c.dataset),Object.defineProperty(this,"dataset",{get:function(){return this._definition.dataset},set:function(a){this._definition.dataset=a}}),Object.defineProperty(this,"specification",{get:function(){return this._definition.specification},set:function(a){this._definition.specification=a}}),Object.defineProperty(this,"override",{get:function(){return this._definition.override},set:function(a){this._definition.override=a}})};return c.prototype.canDraw=function(){return{drawable:!0,errs:[]}},c.prototype.show=function(a){if(this._pendingXhr)this._addToMethodQueue("show",[a]);else{var c;if(a.elementId||(c="Cedar.show requires options.elementId"),null===b.select(a.elementId)[0][0]&&(c="Element "+a.elementId+" is not present in the DOM"),this._elementId=a.elementId,this._renderer=a.renderer||"canvas",a.token&&(this._token=a.token),c)throw new Error(c);var d=this.canDraw();if(!d.drawable){var e=d.issues.join(",");throw new Error("Chart can not be drawn because: "+e)}this.update()}},c.prototype.update=function(){var a=this;if(this._view&&this.emit("update-start"),this._pendingXhr)this._addToMethodQueue("update");else{this._view&&this._remove(this._view);try{var b=c._applyDefaultsToMappings(this._definition.dataset.mappings,this._definition.specification.inputs),d=c._mixin({},this._definition.specification.query,this._definition.dataset.query);d=JSON.parse(c._supplant(JSON.stringify(d),b)),b.query=d;var e=JSON.parse(c._supplant(JSON.stringify(this._definition.specification.template),b));if(e=c._mergeRecursive(e,this._definition.override),e.data[0].url&&delete e.data[0].url,this._definition.dataset.data)e.data[0].values=this._definition.dataset.data,this._renderSpec(e);else{var f=c._createFeatureServiceRequest(this._definition.dataset,d),g=function(b,c){e.data[0].values=c,console.dir(e),a._renderSpec(e)};c.getJson(f,g)}}catch(h){throw h}}},c.prototype._renderSpec=function(b){var c=this;try{a.parse.spec(b,function(a){c._view=a({el:c._elementId,renderer:c._renderer}),c._view.update(),c._attach(c._view),c._view&&c.emit("update-end")})}catch(d){throw d}},c.prototype.select=function(a){var b=this,c=this._view,d=c.model().scene().items[0].items[0].items;d.forEach(function(c){c.datum.data.attributes[a.key]===a.value&&c.hasPropertySet("hover")&&b._view.update({props:"hover",items:c})})},c.prototype.clearSelection=function(a){var b=this,c=this._view,d=c.model().scene().items[0].items[0].items;a&&a.key?d.forEach(function(c){c.datum.data.attributes[a.key]===a.value&&b._view.update({props:"update",items:c})}):b._view.update()},c.prototype.emit=function(a){this._view._handler._handlers[a]&&this._view._handler._handlers[a][0].handler()},c.prototype._attach=function(a){a.on("mouseover",this._handler("mouseover")),a.on("mouseout",this._handler("mouseout")),a.on("click",this._handler("click")),a.on("update-start",this._handler("update-start")),a.on("update-end",this._handler("update-end"))},c.prototype._remove=function(a){a.off("mouseover"),a.off("mouseout"),a.off("click"),a.off("update-start"),a.off("update-end")},c._validateMappings=function(a,b){for(var c,d=[],e=0;e<a.length;e++)c=a[e],c.required&&(b[c.name]||d.push(c.name));return d},c._validateData=function(a,b){var d=[];if(!a.features||!Array.isArray(a.features))throw new Error("Data is expected to have features array!");var e=a.features[0].attributes;for(var f in b){var g=c._getMappingFieldName(f,b[f].field);e.hasOwnProperty(g)||d.push(g)}return d},c._getMappingFieldName=function(a,b){var c=b;return c},c._defaultDefinition=function(){var a={dataset:{query:this._defaultQuery()},template:{}};return a.dataset.query=c._defaultQuery(),a},c._defaultQuery=function(){var a={where:"1=1",returnGeometry:!1,returnDistinctValues:!1,returnIdsOnly:!1,returnCountOnly:!1,outFields:"*",f:"json"};return a},c.prototype._handler=function(a){var b=this,c=function(c,d){b._events.forEach(function(b){b.type===a&&(d?b.callback(d.datum.data.attributes):b.callback())})};return c},c.prototype.on=function(a,b){this._events.push({type:a,callback:b})},c.prototype.off=function(a){console.log("Handler for "+a+" removed...")},c.prototype._addToMethodQueue=function(a,b){this._methodQueue.push({method:a,args:b})},c.prototype._purgeMethodQueue=function(){var a=this;if(a._methodQueue.length>0)for(var b=0;b<a._methodQueue.length;b++){var c=a._methodQueue[b];a[c.method].apply(a,c.args)}},c.getJson=function(a,c){b.json(a,function(b,d){b&&c("Error loading "+a+" "+b.message),c(null,d)})},c._mixin=function(a){for(var c=1;c<arguments.length;c++)b.entries(arguments[c]).forEach(function(b){a[b.key]=b.value});return a},c._createFeatureServiceRequest=function(a,b){var d=c._mixin({},c._defaultQuery(),b);if(d.bbox){if(d.geometry)throw new Error("Dataset.query can not have both a geometry and a bbox specified");var e=d.bbox.split(",");delete d.bbox,d.geometry=JSON.stringify({xmin:e[0],ymin:e[2],xmax:e[1],ymax:e[3]}),d.inSR="4326"}!d.groupByFieldsForStatistics&&a.mappings.group&&(d.groupByFieldsForStatistics=a.mappings.group.field),!d.outStatistics&&a.mappings.count&&(d.orderByFields=a.mappings.count.field+"_SUM",d.outStatistics=JSON.stringify([{statisticType:"sum",onStatisticField:a.mappings.count.field,outStatisticFieldName:a.mappings.count.field+"_SUM"}])),a.mappings.sort&&(d.orderByFields=a.mappings.sort);var f=a.url+"/query?"+this._serializeQueryParams(d);return a.token&&(f=f+"&token="+a.token),f},c._applyDefaultsToMappings=function(a,b){for(var c=[],d=0;d<b.length;d++){var e=b[d];e.required&&!a[e.name]&&c.push(e.name),e.required||a[e.name]||!e["default"]||(a[e.name]=e["default"])}if(c.length>0)throw new Error("Required Mappings Missing: "+c.join(","));return a},c._supplant=function(a,b){return a.replace(/{([^{}]*)}/g,function(a,d){var e=c._getTokenValue(b,d);return"string"==typeof e||"number"==typeof e?e:a})},c._mergeRecursive=function(a,b){for(var d in b)try{b[d].constructor===Object||b[d].constructor===Array?a[d]=c._mergeRecursive(a[d],b[d]):a[d]=b[d]}catch(e){a[d]=b[d]}return a},c._getTokenValue=function(a,b){for(var c=a,d=b.split("."),e=0;e<d.length;e++){if(!c.hasOwnProperty(d[e]))return null;c=c[d[e]]}return c},c._serializeQueryParams=function(a){var b=[];for(var c in a)if(a.hasOwnProperty(c)){var d=a[c];"string"!=typeof d&&(d=JSON.stringify(d)),b.push(encodeURIComponent(c)+"="+encodeURIComponent(d))}var e=b.join("&");return e},c});
//# sourceMappingURL=cedar.min.js.map